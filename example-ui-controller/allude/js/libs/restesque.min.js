function Packet(data){this.obj=data||{body:""}}if(Packet.make=function(){return new Packet},Packet.prototype.body=function(body){return this.obj.body=body,this},Packet.prototype.uri=function(uri){return this.obj.uri=uri,this},Packet.prototype.status=function(status){return this.obj.status=status,this},Packet.prototype.token=function(token){return this.obj.token=token||"",this},Packet.prototype.method=function(method){return this.obj.method=method,this},Packet.prototype.getRef=function(){return this.obj},Packet.prototype.getAsJsonStr=function(errorCallback){"undefined"==typeof errorCallback&&(errorCallback=Packet.defaultJsonError);var str="";try{str=JSON.stringify(this.obj)}catch(err){errorCallback(err)}return str},Packet.prototype.tokensMatch=function(packet){return this.equalsToken(packet.getToken())},Packet.prototype.equalsToken=function(token){return this.obj.token===token},Packet.prototype.hasToken=function(){return"undefined"!=typeof this.obj.token},Packet.prototype.getToken=function(){return this.obj.token},Packet.prototype.hasStatus=function(){return"undefined"!=typeof this.obj.status},Packet.prototype.hasErrorStatus=function(){return this.hasStatus()?this.obj.status==Packet.ERROR:!1},Packet.prototype.hasOkStatus=function(){return this.hasStatus()?this.obj.status==Packet.OK:!1},Packet.prototype.getBody=function(){return this.obj.body},Packet.makeToken=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})},Packet.OK="200",Packet.ERROR="500",Packet.defaultJsonError=function(err){console.error("Packet Json conversion error",err)},"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports=Packet),"undefined"!=typeof module&&"undefined"!=typeof module.exports){module.exports=Restesque;var Packet=require("./packet.js"),W=require("w-js")}var Restesque=function(){function send(ws,packet){var listener;return W.promise(function(resolve,reject){packet.hasToken()||packet.token(Packet.makeToken()),listener=function(receivedPacket){isPacket(receivedPacket)&&(receivedPacket=new Packet(receivedPacket),packet.tokensMatch(receivedPacket)&&(receivedPacket.hasOkStatus()?resolve(receivedPacket):reject(receivedPacket),ws.off("json",listener)))},ws.send(packet.getAsJsonStr(),function(err){return err?reject(err):void ws.on("json",listener)})}).timeoutAfter(RESTESQUE_TIMEOUT_AFTER,function(){ws.off("packet",listener)})}function makeSubscriptionAsync(ws,packet){return W.promise(function(resolve,reject){packet.hasToken()||packet.token("sub-"+Packet.makeToken()),send(ws,packet).success(function(){resolve(new Subscription(ws,packet))}).error(reject)})}function Subscription(ws,packet){this.ws=ws,this.packet=packet,W.extend(this,W.eventMixin),this.ws.on("json",W.bind(this.jsonHandler,this))}function isPacket(obj){return"string"==typeof obj.uri&&"undefined"!=typeof obj.token}var RESTESQUE_TIMEOUT_AFTER=6e4;return Subscription.prototype.jsonHandler=function(receivedPacket){isPacket(receivedPacket)&&(receivedPacket=new Packet(receivedPacket),this.packet.tokensMatch(receivedPacket)&&this.trigger("publish",receivedPacket))},Subscription.prototype.unsubscribe=function(){return W.promise(function(resolve,reject){var packet=W.clone(this.packet);packet.method("UNSUBSCRIBE"),packet.send(packet).success(resolve).error(reject),this.ws.off("json",this.jsonHandler)})},{send:send,makeSubscriptionAsync:makeSubscriptionAsync,Packet:Packet}}();"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports=Restesque);